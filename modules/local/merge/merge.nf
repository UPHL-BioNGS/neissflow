#!/usr/bin/env nextflow

nextflow.enable.dsl=2

process MERGE_REPORTS {
    label 'process_single'

    container "https://depot.galaxyproject.org/singularity/centos:7.9.2009"

    input:
    path(initial_merge)
    path(amr_report)
    path(depth_report)
    path(contaminants)
    path(plasmids)
    path(passed_qc1)
    path(passed_qc2)
    val(prefix)

    output:
    path '*final_report.tsv', emit: final_report 
    path "versions.yml"    , emit: versions

    when:
    task.ext.when == null || task.ext.when

    script:
    """
    tail -n +2 $contaminants | awk 'BEGIN{ OFS="\t" }{ if( \$1 in a ){ a[\$1]=a[\$1]","\$6 } else { a[\$1]=\$6  } }END{ for(i in a){ print i, a[i] } }' | sort -k 1b,1 > contams.tsv
    tail -n +2 $plasmids | awk 'BEGIN{ OFS="\t" }{ if( \$1 in a ){ a[\$1]=a[\$1]","\$6 } else { a[\$1]=\$6  } }END{ for(i in a){ print i, a[i] } }' | sort -k 1b,1 > plasmids.tsv
    awk 'BEGIN{ OFS="\t" }NR==FNR{ A[\$1];next }{ if( \$1 in A ){ print \$1,"pass" } else { print \$1,"fail" }}' $passed_qc1 $initial_merge > qc1.tsv
    awk -v version=${params.version} -v db=${params.ngmasterdb_version} -v run=${params.name} 'BEGIN{ OFS="\t" }NR==FNR{ A[\$1];next }{ if( \$1 in A ){ print \$1,\$2,"pass",version,db,run } else if( \$2 == "pass" ){ print \$1,\$2,"fail",version,db,run  } else { print \$1,\$2,"N/A",version,db,run } }' $passed_qc2 qc1.tsv > qc2.tsv
    tail -n +2 $initial_merge | sort -k 1b,1 | sed -e "s/\r//g" | join -a1 -a2 \
        -o 0,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,1.10,1.11,1.12,1.13,1.14,1.15,1.16,1.17,1.18,1.19,1.20,1.21,1.22,1.23,1.24,1.25,1.26,1.27,1.28,1.29,1.30,1.31,1.32,1.33,1.34,1.35,1.36,1.37,1.38,1.39,1.40,1.41,1.42,1.43,1.44,1.45,1.46,1.47,2.2,2.3,2.4,2.5,2.6,2.7,2.8,2.9,2.10,2.11,2.12,2.13,2.14,2.15,2.16,2.17,2.18,2.19,2.20,2.21,2.22,2.23,2.24,2.25,2.26,2.27,2.28,2.29,2.30,2.31,2.32,2.33,2.34,2.35,2.36,2.37,2.38,2.39,2.40,2.41,2.42,2.43,2.44,2.45,2.46,2.47,2.48,2.49,2.50,2.51,2.52,2.53,2.54,2.55,2.56,2.57,2.58,2.59,2.60,2.61,2.62,2.63,2.64,2.65,2.66,2.67,2.68,2.69,2.70,2.71,2.72,2.73,2.74,2.75,2.76,2.77,2.78,2.79,2.80,2.81,2.82,2.83,2.84,2.85,2.86,2.87,2.88 \
        -e 'skip' -j 1 -t \$'\t' - <(tail -n +2 $amr_report | sort -k 1b,1) | join -a1 -a2 \
        -o 0,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,1.10,1.11,1.12,1.13,1.14,1.15,1.16,1.17,1.18,1.19,1.20,1.21,1.22,1.23,1.24,1.25,1.26,1.27,1.28,1.29,1.30,1.31,1.32,1.33,1.34,1.35,1.36,1.37,1.38,1.39,1.40,1.41,1.42,1.43,1.44,1.45,1.46,1.47,1.48,1.49,1.50,1.51,1.52,1.53,1.54,1.55,1.56,1.57,1.58,1.59,1.60,1.61,1.62,1.63,1.64,1.65,1.66,1.67,1.68,1.69,1.70,1.71,1.72,1.73,1.74,1.75,1.76,1.77,1.78,1.79,1.80,1.81,1.82,1.83,1.84,1.85,1.86,1.87,1.88,1.89,1.90,1.91,1.92,1.93,1.94,1.95,1.96,1.97,1.98,1.99,1.100,1.101,1.102,1.103,1.104,1.105,1.106,1.107,1.108,1.109,1.110,1.111,1.112,1.113,1.114,1.115,1.116,1.117,1.118,1.119,1.120,1.121,1.122,1.123,1.124,1.125,1.126,1.127,1.128,1.129,1.130,1.131,1.132,1.133,1.134,2.2,2.3,2.4,2.5,2.6,2.7,2.8,2.9,2.10,2.11,2.12,2.13,2.14,2.15,2.16,2.17,2.18,2.19,2.20,2.21,2.22,2.23,2.24,2.25,2.26,2.27 \
        -e 'skip' -j 1 -t \$'\t' - <(tail -n +2 $depth_report | sort -k 1b,1) > report.tsv

    header1=\$(head -n 1 $initial_merge | sed -e "s/\r//g")
    header2=\$(cut -f 2- $amr_report | head -n 1)
    header3=\$(cut -f 2- $depth_report | head -n 1)
    header4="contaminants"
    header5="plasmids"
    header6="neissflow_qc_check_1"
    header7="neissflow_qc_check_2"
    header8="neissflow_version"
    header9="alleledb_version"
    header10="run_info"

    printf "%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\n" "\$header1" "\$header2" "\$header3" "\$header4" "\$header5" "\$header6" "\$header7" "\$header8" "\$header9" "\$header10" > ${prefix}_final_report.tsv

    join -a1 -a2 \
        -o 0,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,1.10,1.11,1.12,1.13,1.14,1.15,1.16,1.17,1.18,1.19,1.20,1.21,1.22,1.23,1.24,1.25,1.26,1.27,1.28,1.29,1.30,1.31,1.32,1.33,1.34,1.35,1.36,1.37,1.38,1.39,1.40,1.41,1.42,1.43,1.44,1.45,1.46,1.47,1.48,1.49,1.50,1.51,1.52,1.53,1.54,1.55,1.56,1.57,1.58,1.59,1.60,1.61,1.62,1.63,1.64,1.65,1.66,1.67,1.68,1.69,1.70,1.71,1.72,1.73,1.74,1.75,1.76,1.77,1.78,1.79,1.80,1.81,1.82,1.83,1.84,1.85,1.86,1.87,1.88,1.89,1.90,1.91,1.92,1.93,1.94,1.95,1.96,1.97,1.98,1.99,1.100,1.101,1.102,1.103,1.104,1.105,1.106,1.107,1.108,1.109,1.110,1.111,1.112,1.113,1.114,1.115,1.116,1.117,1.118,1.119,1.120,1.121,1.122,1.123,1.124,1.125,1.126,1.127,1.128,1.129,1.130,1.131,1.132,1.133,1.134,1.135,1.136,1.137,1.138,1.139,1.140,1.141,1.142,1.143,1.144,1.145,1.146,1.147,1.148,1.149,1.150,1.151,1.152,1.153,1.154,1.155,1.156,1.157,1.158,1.159,1.160,2.2 \
        -e 'skip' -j 1 -t \$'\t' report.tsv contams.tsv | join -a1 -a2 \
        -o 0,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,1.10,1.11,1.12,1.13,1.14,1.15,1.16,1.17,1.18,1.19,1.20,1.21,1.22,1.23,1.24,1.25,1.26,1.27,1.28,1.29,1.30,1.31,1.32,1.33,1.34,1.35,1.36,1.37,1.38,1.39,1.40,1.41,1.42,1.43,1.44,1.45,1.46,1.47,1.48,1.49,1.50,1.51,1.52,1.53,1.54,1.55,1.56,1.57,1.58,1.59,1.60,1.61,1.62,1.63,1.64,1.65,1.66,1.67,1.68,1.69,1.70,1.71,1.72,1.73,1.74,1.75,1.76,1.77,1.78,1.79,1.80,1.81,1.82,1.83,1.84,1.85,1.86,1.87,1.88,1.89,1.90,1.91,1.92,1.93,1.94,1.95,1.96,1.97,1.98,1.99,1.100,1.101,1.102,1.103,1.104,1.105,1.106,1.107,1.108,1.109,1.110,1.111,1.112,1.113,1.114,1.115,1.116,1.117,1.118,1.119,1.120,1.121,1.122,1.123,1.124,1.125,1.126,1.127,1.128,1.129,1.130,1.131,1.132,1.133,1.134,1.135,1.136,1.137,1.138,1.139,1.140,1.141,1.142,1.143,1.144,1.145,1.146,1.147,1.148,1.149,1.150,1.151,1.152,1.153,1.154,1.155,1.156,1.157,1.158,1.159,1.160,1.161,2.2 \
        -e 'skip' -j 1 -t \$'\t' - plasmids.tsv | join -a1 -a2 \
        -o 0,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,1.10,1.11,1.12,1.13,1.14,1.15,1.16,1.17,1.18,1.19,1.20,1.21,1.22,1.23,1.24,1.25,1.26,1.27,1.28,1.29,1.30,1.31,1.32,1.33,1.34,1.35,1.36,1.37,1.38,1.39,1.40,1.41,1.42,1.43,1.44,1.45,1.46,1.47,1.48,1.49,1.50,1.51,1.52,1.53,1.54,1.55,1.56,1.57,1.58,1.59,1.60,1.61,1.62,1.63,1.64,1.65,1.66,1.67,1.68,1.69,1.70,1.71,1.72,1.73,1.74,1.75,1.76,1.77,1.78,1.79,1.80,1.81,1.82,1.83,1.84,1.85,1.86,1.87,1.88,1.89,1.90,1.91,1.92,1.93,1.94,1.95,1.96,1.97,1.98,1.99,1.100,1.101,1.102,1.103,1.104,1.105,1.106,1.107,1.108,1.109,1.110,1.111,1.112,1.113,1.114,1.115,1.116,1.117,1.118,1.119,1.120,1.121,1.122,1.123,1.124,1.125,1.126,1.127,1.128,1.129,1.130,1.131,1.132,1.133,1.134,1.135,1.136,1.137,1.138,1.139,1.140,1.141,1.142,1.143,1.144,1.145,1.146,1.147,1.148,1.149,1.150,1.151,1.152,1.153,1.154,1.155,1.156,1.157,1.158,1.159,1.160,1.161,1.162,2.2,2.3,2.4,2.5,2.6 \
        -e 'skip' -j 1 -t \$'\t' - <(tail -n +2 qc2.tsv | sort -k 1b,1) >> ${prefix}_final_report.tsv

    cat <<-END_VERSIONS > versions.yml
    "${task.process}":
        Awk: \$(awk --version 2>&1 | sed -n 1p | sed 's/GNU Awk //')
    END_VERSIONS

    """
}